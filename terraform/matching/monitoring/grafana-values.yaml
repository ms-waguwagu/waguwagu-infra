adminUser: admin
adminPassword: admin

service:
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: external
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

########################
# Datasources
########################
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # - name: Prometheus-Game
      #   type: prometheus
      #   url: http://k8s-monitori-promethe-8a1d8adbee-8b401e8a0e6da178.elb.ap-northeast-2.amazonaws.com #하드코딩, 매일 바꿔야 하는 값
      #   access: proxy
      #   isDefault: true

      - name: Prometheus-Matching
        type: prometheus
        url: http://prometheus-server.monitoring.svc.cluster.local
        access: proxy
        isDefault: false

      - name: Loki
        type: loki
        url: http://loki.monitoring.svc.cluster.local:3100
        access: proxy
        isDefault: false

########################
# Dashboard
########################
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: game
        orgId: 1
        folder: Game
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/game

      - name: matching
        orgId: 1
        folder: Matching
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/matching

      - name: loki
        orgId: 1
        folder: Loki
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/loki

dashboards:
  game:
    kubernetes-cluster-game:
      gnetId: 7249
      revision: 1
      datasource: Prometheus-Game

  matching:
    kubernetes-cluster-matching:
      gnetId: 15757
      revision: 1
      datasource: Prometheus-Matching

  loki:
    loki-logs-stable:
      adminUser: admin
adminPassword: admin

service:
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: external
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing

########################
# Datasources
########################
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # - name: Prometheus-Game
      #   type: prometheus
      #   url: http://k8s-monitori-promethe-8a1d8adbee-8b401e8a0e6da178.elb.ap-northeast-2.amazonaws.com #하드코딩, 매일 바꿔야 하는 값
      #   access: proxy
      #   isDefault: true

      - name: Prometheus-Matching
        type: prometheus
        url: http://prometheus-server.monitoring.svc.cluster.local
        access: proxy
        isDefault: false

      - name: Loki
        type: loki
        url: http://loki.monitoring.svc.cluster.local:3100
        access: proxy
        isDefault: false

########################
# Dashboard
########################
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: game
        orgId: 1
        folder: Game
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/game

      - name: matching
        orgId: 1
        folder: Matching
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/matching

      - name: loki
        orgId: 1
        folder: Loki
        type: file
        disableDeletion: true
        editable: false
        options:
          path: /var/lib/grafana/dashboards/loki

dashboards:
  game:
    kubernetes-cluster-game:
      gnetId: 7249
      revision: 1
      datasource: Prometheus-Game

  matching:
    kubernetes-cluster-matching:
      gnetId: 15757
      revision: 1
      datasource: Prometheus-Matching

  loki:
    loki-logs-stable:
      json: |
        {
          "uid": "loki-logs-stable",
          "title": "Loki Logs (Stable)",
          "tags": ["loki", "logs"],
          "timezone": "browser",
          "schemaVersion": 38,
          "version": 4,
          "refresh": "10s",

          "templating": {
            "list": [
              {
                "name": "namespace",
                "type": "query",
                "datasource": { "type": "loki", "uid": "Loki" },
                "query": "label_values({namespace!=\"\"}, namespace)",
                "refresh": 1,
                "includeAll": true,
                "allValue": ".+"
              },
              {
                "name": "pod",
                "type": "query",
                "datasource": { "type": "loki", "uid": "Loki" },
                "query": "label_values({namespace=~\"$namespace\"}, pod)",
                "refresh": 1,
                "includeAll": true,
                "allValue": ".+"
              },
              {
                "name": "container",
                "type": "query",
                "datasource": { "type": "loki", "uid": "Loki" },
                "query": "label_values({namespace=~\"$namespace\", pod=~\"$pod\"}, container)",
                "refresh": 1,
                "includeAll": true,
                "allValue": ".+"
              },
              {
                "name": "level",
                "type": "custom",
                "query": "ERROR,WARN,INFO",
                "includeAll": true,
                "allValue": ".*"
              }
            ]
          },

          "panels": [
            {
              "id": 1,
              "type": "logs",
              "title": "All Logs",
              "datasource": { "type": "loki", "uid": "Loki" },
              "gridPos": { "x": 0, "y": 0, "w": 24, "h": 10 },
              "targets": [
                {
                  "expr": "{namespace=~\"$namespace\", pod=~\"$pod\", container=~\"$container\"} |~ \"$level\"",
                  "refId": "A"
                }
              ],
              "options": {
                "showTime": true,
                "wrapLogMessage": true
              }
            },

            {
              "id": 2,
              "type": "timeseries",
              "title": "Log Rate (All)",
              "datasource": { "type": "loki", "uid": "Loki" },
              "gridPos": { "x": 0, "y": 10, "w": 24, "h": 8 },
              "targets": [
                {
                  "expr": "sum(rate({namespace=~\"$namespace\", pod=~\"$pod\", container=~\"$container\"}[5m]))",
                  "refId": "A"
                }
              ]
            }
          ]
        }


# ########################
# # Sidecar (필수)
# ########################
sidecar:
  dashboards:
    enabled: true

########################
# Anonymous Access
########################
grafana.ini:
  auth.anonymous:
    enabled: true
    org_role: Viewer

# ########################
# # Sidecar (필수)
# ########################
sidecar:
  dashboards:
    enabled: true

########################
# Anonymous Access
########################
grafana.ini:
  auth.anonymous:
    enabled: true
    org_role: Viewer
