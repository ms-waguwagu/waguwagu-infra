AWSTemplateFormatVersion: "2010-09-09"
Description: T3-Wagu Production RDS MySQL Stack

Parameters:
  DBName:
    Type: String
    Default: wagudb
  DBInstanceClass:
    Type: String
    Default: db.t3.medium
  AllocatedStorage:
    Type: Number
    Default: 50
  MasterUsername:
    Type: String
    Default: wagu_admin
    AllowedPattern: "[a-zA-Z0-9_]+"

Resources:
  # [1. Security Group]
  WaguProdDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL from App VPC
      VpcId: !ImportValue T3-Wagu-Matching-VPC-Id
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.0.0.0/16 
          Description: "Allow MySQL Access from VPC"

  # [2. Subnet Group]
  WaguProdDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Prod subnet group for Wagu RDS
      SubnetIds: !Split
        - ","
        - !ImportValue T3-Wagu-Matching-Private-Db-Subnet-Ids

  # [3. Parameter Group] utf8mb4 support
  WaguProdDBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Family: "mysql8.0"
      Description: "Parameter group for utf8mb4 support"
      Parameters:
        character_set_server: "utf8mb4"
        character_set_database: "utf8mb4"
        character_set_client: "utf8mb4"
        character_set_connection: "utf8mb4"
        collation_server: "utf8mb4_unicode_ci"
        time_zone: "Asia/Seoul"

  # [4. DB Instance]
  WaguProdDBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      DBInstanceIdentifier: t3-wagu-prod-db
      Engine: mysql
      DBName: !Ref DBName
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref AllocatedStorage
      StorageType: gp2
      StorageEncrypted: true
      
      MasterUsername: !Ref MasterUsername
      # Managed by AWS Secrets Manager
      ManageMasterUserPassword: true 

      PubliclyAccessible: false
      MultiAZ: true
      BackupRetentionPeriod: 14
      PreferredBackupWindow: 02:00-03:00

      VPCSecurityGroups:
        - !Ref WaguProdDBSecurityGroup
      DBSubnetGroupName: !Ref WaguProdDBSubnetGroup
      DBParameterGroupName: !Ref WaguProdDBParameterGroup

      DeletionProtection: true
      EnableCloudwatchLogsExports:
        - error
        - general
        - slowquery
      
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7

Outputs:
  ProdDBEndpoint:
    Description: Production RDS Endpoint
    Value: !GetAtt WaguProdDBInstance.Endpoint.Address
    Export:
      Name: T3-Wagu-Prod-DB-Endpoint

  ProdDBPort:
    Description: Production RDS Port
    Value: !GetAtt WaguProdDBInstance.Endpoint.Port

  ProdDBSecretArn:
    Description: The ARN of the Secrets Manager secret storing the DB credentials
    Value: !GetAtt WaguProdDBInstance.MasterUserSecret.SecretArn
    Export:
      Name: T3-Wagu-Prod-DB-Secret-Arn